<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Compliance Relay</title></head>
<body>
<script>
// RELAY: served from OnlyOffice origin (localhost:8080).
// Receives postMessage from React (localhost:3000).
// Uses localStorage (shared with the plugin on same origin) to pass search commands.
// The plugin polls localStorage for changes.

console.log('[ComplianceRelay] Relay loaded, origin:', window.location.origin);

window.addEventListener('message', function(event) {
    var data = null;
    try {
        if (typeof event.data === 'string') {
            data = JSON.parse(event.data);
        } else {
            data = event.data;
        }
    } catch(e) {
        return;
    }

    if (!data || data.type !== 'complianceSearch') return;
    if (!data.data || data.data.type !== 'searchText') return;

    var text = data.data.text || '';
    var severity = data.data.severity || 'medium';

    // Clean and truncate
    var searchText = text.replace(/\s+/g, ' ').trim();
    if (searchText.length > 50) searchText = searchText.substring(0, 50);

    console.log('[ComplianceRelay] Writing search to localStorage:', searchText);

    // Write to localStorage â€” the plugin (same origin) reads this
    try {
        localStorage.setItem('compliance_search', JSON.stringify({
            text: searchText,
            severity: severity,
            timestamp: Date.now()
        }));
        console.log('[ComplianceRelay] localStorage updated');
    } catch(e) {
        console.error('[ComplianceRelay] localStorage write failed:', e);
    }
}, false);
</script>
</body>
</html>
